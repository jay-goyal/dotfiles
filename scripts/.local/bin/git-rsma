#!/usr/bin/env bash

set -euo pipefail

parent_dir=$(pwd)

[ -d "$parent_dir/.git" ] || git init

for gitdir in $(fd -HI -t d -d 10 '^\.git$' .); do
    repo_path=$(dirname "$gitdir")
    abs_path=$(realpath "$repo_path")

    if [ "$repo_path" = "." ]; then
        continue
    fi

    if git config --file .gitmodules --get-regexp path | grep -q " $repo_path\$"; then
        echo "[WARN] $gitdir already present as submodule"
        continue
    fi

    echo "[INFO] Adding submodule: $repo_path"
    git submodule add "$abs_path" "$repo_path"
done

git commit -m "Added all submodules"
